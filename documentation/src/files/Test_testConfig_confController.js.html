<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Test/testConfig/confController.js - yocto-core-stack</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-core-stack" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ConfController.html">ConfController</a></li>
                                <li><a href="../classes/Gruntfile.html">Gruntfile</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/copy.html">copy</a></li>
                                <li><a href="../modules/Grunt file.html">Grunt file</a></li>
                                <li><a href="../modules/jshint.html">jshint</a></li>
                                <li><a href="../modules/ng.html">ng</a></li>
                                <li><a href="../modules/ngMessages.html">ngMessages</a></li>
                                <li><a href="../modules/ngMock.html">ngMock</a></li>
                                <li><a href="../modules/ngMockE2E.html">ngMockE2E</a></li>
                                <li><a href="../modules/uglify.html">uglify</a></li>
                                <li><a href="../modules/yuidoc.html">yuidoc</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: Test/testConfig/confController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use-strict&#x27;;

var path     = require(&#x27;path&#x27;);
var _        = require(&#x27;lodash&#x27;);
var winston  = require(&#x27;winston&#x27;);


 /**
   * IS the absoluth path of the project
   *
   * @property ROOT_PATH
   */
 var ROOT_PATH = path.normalize(__dirname + &#x27;/../..&#x27;);

/**
  * Contains all parameters for system configuration
  *
  * @property allFile
  */
var allFile = require(path.join( ROOT_PATH , &#x27;Test/testConfig/config/all.js&#x27;));

/**
  * Contains all parameters for common application configuration
  *
  * @property commonConfFile
  */
var commonConfFile = require(path.join( ROOT_PATH , &#x27;Test/testConfig/config/common.json&#x27;));

/**
  * Contains all policies for checking new configuration
  *
  * @property policies
  */
var policies = require(path.join( ROOT_PATH , &#x27;Test/testConfig/config/policies.json&#x27;));

/**
  * Object that permit to log information
  *
  * @property logger
  */
var logger  = new (winston.Logger)( {
    transports : [
        new (winston.transports.Console)( {
            colorize : true
        }),
    ]
});


/**
 * Yocto config controller. Manage your configuration in correlation with the NODE_ENV variable.
 *
 *
 *
 * For more details on these dependencies read links below :
 * - Winston : https://github.com/flatiron/winston
 * - LodAsh : https://lodash.com/
 * - path : https://nodejs.org/api/path.html
 *
 *
 * @date : 24/04/2015
 * @author : CÃ©dric BALARD &lt;cedric@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved
 * @class ConfController
 */
function ConfController() {
    //Save the context
    var context = this;

    /**
     * Create the main object that will contain all configuration
     *
     * @type {Object}
     */
    this.config = {};

    /**
    * Prepocess run process with the configuration file based on &quot;process.env.NODE_ENV&quot;
    *
    * @method preProcessConf
    * @param {String} mode type of configuration (Eg. &#x27;developpement&#x27;, &#x27;staging&#x27;, &#x27;production&#x27;)
    * @throw error config file
    */
    var preProcessConf = function() {
        try {
            var pathConf = path.join( ROOT_PATH , &#x27;Test/testConfig/config&#x27;, (process.env.NODE_ENV+&#x27;.json&#x27;));
            processConf(pathConf);
        } catch (e) {
            throw new Error (&#x27;Config file not found at : &#x27; +  pathConf + &#x27;\n&#x27; +e );
        }
    };

    /**
    * Check if all new data is good with @function{checkDataIntegrity}
    * If it&#x27;s okay, we merge the new data into commonFile.js
    *
    * @metho processConf
    * @param {[String]} path Path of file configuration
    */
    var processConf = function ( path ) {
        try {
            var file = require ( path );

            if ( context.checkDataIntegrity(file) ) {
                logger.info( &#x27;[+] data checking success&#x27;);

                //Instanciate the main config
                context.config = _.merge( commonConfFile, file );

                // now importOject all.js and add it into &#x27;config&#x27; in the subObject named &#x27;sys&#x27;
                var sys = { &#x27;sys&#x27; : allFile };
                _.assign( context.config, sys );
            }
            else  {
                logger.info( &#x27;[-] data checking fail&#x27; );
            }
        } catch (e) {
            throw new Error ( &#x27; ProcessConf() error &#x27; + e );
        }
    };

    /**
     * Read policies.json and compare all type with the given file
     *
     * @method checkDataIntegrity
     * @param {[type]} file [description]
     */
    this.checkDataIntegrity = function ( file ) {
        console.log(&#x27;-------checkDataIntegrity-------&#x27;);
        var listError = [];

        //Read each line in policies.json
        _.forEach(policies.policies, function (value, key) {
            var tab     = _.words(key, /[^, , \.]+/g) ;
            var fileTmp = file;

            //Get the value of the given object (eg. key)
            _.forEach( tab, function (val) {
                fileTmp = ( _.at(fileTmp, val ) );
                fileTmp = _.first(fileTmp);
            });

            //If is not undefined we check type of the new parameter
            if (! _.isUndefined(fileTmp) ) {
                listError.push( checkIfType(value, fileTmp, key ) );
            }
        });

        //remove all null value
        listError = _.compact(listError);

        if ( _.isEmpty(listError) ) {
            logger.info( &#x27;all data is correct, we can merge data&#x27;);
            return true;
        }
        else {
            logger.error( &#x27; Error : &#x27; + listError.length + &#x27; parameter(s) isn\&#x27;t (aren\&#x27;t) conform \n&#x27; +
                          _(listError).join(&#x27;\n&#x27;)    );
            return false;
        }

    };

    /**
     * Check type of &#x27;param&#x27; for a given type
     * @param {String} type        Desired type
     * @param {Object} param       The object to test
     * @param {Sting} paramString Name of the obejc to check
     * @return
     */
    var checkIfType =  function( type, param, paramString) {
        logger.info( &#x27;Analyse type :&#x27;, type ,&#x27;, paramString :&#x27;, paramString,&#x27;param : &#x27;, param);

        if( type == &#x27;string&#x27;) {
            if ( _.isString( param ) ) {
                return null;
            }
        }
        else if( type == &#x27;boolean&#x27; ) {
            if ( _.isBoolean( param ) ) {
                return null;
            }
        }
        else if( type == &#x27;number&#x27; ) {
            if ( _.isNumber( param ) ) {
                return null;
            }
            else if ( _.isString( param ) ) {
                if (! _.isNaN( _.parseInt(param) ) ) {
                    return null;
                }
            }
        }
        return paramString + &#x27; : should be a &#x27; + type ;
    };

    //Run all the process to create the object
    preProcessConf();
}

/**
 * Permit to update configuration dynamiclly
 *
 * @param {[type]} dataToExtend New parameters
 */
ConfController.prototype.extendConf = function( dataToExtend) {

    // Check if all data match with all policies
    if ( this.checkDataIntegrity(dataToExtend) ){
        _.merge( this.config, dataToExtend );
        return true;
    }
    return false;
};

/**
 * Export the ConfController
 */
module.exports = new (ConfController)();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
