<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>config_old/express.js - yocto-core-stack</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-core-stack" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Gruntfile.html">Gruntfile</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/copy.html">copy</a></li>
                                <li><a href="../modules/Grunt file.html">Grunt file</a></li>
                                <li><a href="../modules/jshint.html">jshint</a></li>
                                <li><a href="../modules/ng.html">ng</a></li>
                                <li><a href="../modules/ngMessages.html">ngMessages</a></li>
                                <li><a href="../modules/ngMock.html">ngMock</a></li>
                                <li><a href="../modules/ngMockE2E.html">ngMockE2E</a></li>
                                <li><a href="../modules/uglify.html">uglify</a></li>
                                <li><a href="../modules/yuidoc.html">yuidoc</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: config_old/express.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Dependencies
 * @documentation : https://github.com/strongloop/express
 * @see : http://expressjs.com/api.html
 * @see : http://nodejs.org/api/fs.html
 * @see : https://github.com/senchalabs/connect
 * @see : https://github.com/expressjs/compression
 * @see : https://github.com/expressjs/cookie-parser
 * @see : https://github.com/expressjs/body-parser
 * @see : https://github.com/expressjs/method-override
 * @see : https://github.com/expressjs/session
 * @see : https://www.npmjs.org/package/uuid
 * @see : https://www.npmjs.org/package/connect-flash
 * @see : https://github.com/epeli/underscore.string
 * @see : https://www.npmjs.org/package/dateformat
 * @see : https://www.npmjs.org/package/express-less
 * @see : https://www.npmjs.com/package/connect-multiparty
 * @see : https://www.npmjs.com/package/vhost
 * @see : https://github.com/senchalabs/connect
 * @see : https://www.npmjs.com/package/serve-static
 * @author :  Mathieu ROBERT &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved 
 */

var config          = require(&#x27;./config&#x27;);
var logger          = require(config.yoctoModules(&#x27;logger&#x27;));
var social          = require(config.yoctoModules(&#x27;social&#x27;));
var utils           = require(config.yoctoModules(&#x27;utils&#x27;));
var fs              = require(&#x27;fs&#x27;);
var express         = require(&#x27;express&#x27;);
var compression     = require(&#x27;compression&#x27;);
var cookieParser    = require(&#x27;cookie-parser&#x27;); 
var bodyParser      = require(&#x27;body-parser&#x27;);
var methodOverride  = require(&#x27;method-override&#x27;);
var session         = require(&#x27;express-session&#x27;);
var helpers         = require(&#x27;view-helpers&#x27;);
var _               = require(&#x27;underscore&#x27;);
var uuid            = require(&#x27;uuid&#x27;);
var flash           = require(&#x27;connect-flash&#x27;);
var _s              = require(&#x27;underscore.string&#x27;);
var df              = require(&#x27;dateformat&#x27;);
var multipart       = require(&#x27;connect-multiparty&#x27;);
var vhost           = require(&#x27;vhost&#x27;);
var connect         = require(&#x27;connect&#x27;);
var favicon         = require(&#x27;serve-favicon&#x27;);
var render          = require(config.yoctoModules(&#x27;render&#x27;));
var prerender       = require(&#x27;prerender-node&#x27;);

// setting up pre-render
prerender.set(&#x27;prerenderToken&#x27;, &#x27;mRVbkWNCFzaWWUeq4y0y&#x27;);
// blacklist ad item
prerender.blacklisted([&#x27;/ad/.*/.*/ad-.{32}-[0-9]*.html&#x27;]);

// add woo boot on config for seo test
prerender.crawlerUserAgents.push(&#x27;woobot&#x27;);

// hard force for prerender;
prerender.set(&#x27;beforeRender&#x27;, function(req, done) {
    var host = utils.getCorrectHost(req);
    host = host.replace(&#x27;http://&#x27;, &#x27;&#x27;);
    req.headers.host = host;
    done();
});

// mixin underscore js ans underscore.string js to use the same namespace
_.mixin(_s.exports());

module.exports = function(app) {

  logger.banner(&#x27;Initializing Express ...&#x27;);
  
  var constants = config.constants;

  /**
   * Setting up the current port on var into the current app
   */
  var port      = 3000;
  var appName   = (uuid.v4() + &#x27;-&#x27; + df(new Date(), &#x27;yyyymd&#x27;)); 
   
  if (!(_.isUndefined(constants.PORT))) {
    if (!_.isNumber(constants.PORT)) {
      port = _.toNumber(constants.PORT);
    } else {
        port = constants.PORT;
    }
  }
  
  logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up the current port to use for the web server at [&#x27;, port, &#x27;]&#x27;));   
  app.set(&#x27;port&#x27;, port);


  /**
   * Setting up the current env for app
   */
   logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up your current app to&#x27;, constants.ENV));
   app.set(&#x27;env&#x27;, constants.ENV);

  /**
   * Processing config. Setting up the stack error display
   */
  if (!(_.isUndefined(config.app))) {
    var aConfig = config.app;
      
    if (!(_.isUndefined(aConfig.stackError))) {
      if (_.isBoolean(aConfig.stackError) &amp;&amp; aConfig.stackError) {  
        app.set(&#x27;showStackError&#x27;, aConfig.stackError);
      }
    }
  }
  
  /**
   * Setting up the current app name to express app
   */
  if (!(_.isUndefined(aConfig))) {
    appName =  aConfig.name || appName;
  }
   
  logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up the current app name to use to [&#x27;, appName, &#x27;]&#x27;));
  app.set(&#x27;app_name&#x27;, appName);

  /**
   * Setting up pretty HTML for express
   */
  if (!(_.isUndefined(config.express))) {
    var eConfig = config.express;
      
    if (!(_.isUndefined(eConfig.prettyHtml))) {
      if (_.isBoolean(eConfig.prettyHtml) &amp;&amp; eConfig.prettyHtml) {
        app.locals.pretty = eConfig.prettyHtml;
      }
    }
    
    /**
     * Setting up filter for express compression
     */
    if (!(_.isUndefined(eConfig.filter))) {
    
      var eFilter = eConfig.filter;
    
      if (!(_.isUndefined(eFilter.rules)) &amp;&amp; !(_.isUndefined(eFilter.by)) &amp;&amp; !(_.isUndefined(eFilter.level))) {
        if ((_.isString(eFilter.rules)) &amp;&amp; (_.isString(eFilter.by)) &amp;&amp; (_.isNumber(eFilter.level))) {
          
          logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up compression rules with filter [&#x27;, eFilter.rules, &#x27;] for [&#x27;, eFilter.by, &#x27;] at level [&#x27;, eFilter.level, &#x27;]&#x27;));
          app.use(compression({
            filter : function(request, response) {
              var rules = new RegExp(eFilter.rules);
              return rules.test(response.getHeader(eFilter.by));
            },
            level : eFilter.level
          }));
        }
      }
    }
    
    // Setting up vhost and http edirect 
    if (!_.isUndefined(eConfig.vhost)) {
      var vhostConfig = eConfig.vhost;

      var vhostapp = connect();

      if (!_.isUndefined(vhostConfig.enable)) {
        if (vhostConfig.enable) {
          logger.debug(&#x27;Vhost setting is enable. Starting set up&#x27;);
          
          if (!_.isUndefined(vhostConfig.url) &amp;&amp; !_.isUndefined(vhostConfig.aliases)) {
            if (!_.isUndefined(vhostConfig.subdomains) &amp;&amp; _.isBoolean(vhostConfig.subdomains)) {
              
              var fullVhost = _.join(&#x27;.&#x27;, &#x27;www&#x27;, vhostConfig.url);
                              
              function setupVhost(main, url, isAlias, subdomains) {
                // main full vhost
                var host      = _.join(&#x27;.&#x27;, &#x27;www&#x27;, url);
                var firstMsg  = (isAlias ? _.join(&#x27; &#x27;, &#x27;[ &#x27;, url, &#x27; ] alias for main&#x27;) : &#x27;main&#x27;);
                var secondMsg = (isAlias ? _.join(&#x27; &#x27;, &#x27;[ &#x27;, host, &#x27; ] alias for main&#x27;) : &#x27;main&#x27;);                
                
                logger.debug(_.join(&#x27; &#x27;, &#x27;Adding&#x27;, firstMsg, &#x27;vhost&#x27;, (isAlias ? main : url)));                               
                app.use(vhost(url, vhostapp));
                
                logger.debug(_.join(&#x27; &#x27;, &#x27;Adding&#x27;, secondMsg, &#x27;vhost&#x27;, (isAlias ? main : host)));
                app.use(vhost(host, vhostapp));
                
                // must process subdomains
                if (subdomains) {
                  var allSubDomains = _.join(&#x27;.&#x27;, &#x27;*&#x27;, url);
                  logger.debug(_.join(&#x27; &#x27;, &#x27;Subdomains is enabled. enable sub domains vhost for&#x27;, allSubDomains));
                  app.use(vhost(allSubDomains, vhostapp));
                }                
              }
              
              // default vhost
              setupVhost(vhostConfig.url, vhostConfig.url, false, vhostConfig.subdomains);

              // process all aliased
              _.each(vhostConfig.aliases, function(vhosturl) {
                setupVhost(vhostConfig.url, vhosturl, true, vhostConfig.subdomains);
              });
              
              // setting up htaccess redirect. Check if property is ok
              if (_.has(vhostConfig, &#x27;http&#x27;)) {

                if (_.has(vhostConfig.http, &#x27;redirect&#x27;) &amp;&amp; !_.isUndefined(vhostConfig.http.redirect)) {

                  var httpr = vhostConfig.http.redirect;
  
                  // default value
                  var fdRules = {
                    hostname : fullVhost,
                    port     : constants.PORT,
                  };
                  
                  // check if require property is valid
                  if (_.has(httpr, &#x27;port&#x27;) &amp;&amp; _.has(httpr, &#x27;url&#x27;) &amp;&amp; _.has(httpr, &#x27;type&#x27;)) {
                    if (_.isNumber(httpr.port) &amp;&amp; !_.isNaN(httpr.port)) {
                      fdRules.port = httpr.port;
                    }
                    
                    if (!_.isNull(httpr.url) &amp;&amp; !_.isEmpty(httpr.url)) {
                      fdRules.hostname = httpr.url;
                    }
                    
                    if (_.isNumber(httpr.type) &amp;&amp; !_.isNaN(httpr.type)) {
                      _.extend(fdRules,  { type : httpr.type });
                    }

                    var fdomainMsg = _.join(&#x27;&#x27;, &#x27;Setting up http redirect for current vhost  [ &#x27;, fdRules.hostname, &#x27; ] on port : [ &#x27;, fdRules.port, &#x27; ] for type : [ &#x27;, fdRules.type, &#x27; ]&#x27;);
  
                    if (_.has(fdRules, &#x27;hostname&#x27;) &amp;&amp; !_.isNull(fdRules.hostname) &amp;&amp; !_.isEmpty(fdRules.hostname) &amp;&amp; _.has(fdRules, &#x27;port&#x27;) &amp;&amp; _.has(fdRules, &#x27;type&#x27;) &amp;&amp; _.isNumber(fdRules.type)) {
                      logger.debug(fdomainMsg);

                      // process redirect on for request                      
                      app.use(function(req, res, next) {
                        var r   = utils.getCorrectHost(req);
                        var rr  = _.join(&#x27;://&#x27;, req.protocol, fdRules.hostname);
                        var vr  = _.join(&#x27;://&#x27;, req.protocol, fullVhost);
                        
                        
                        // check if is different
                        if (r != vr &amp;&amp; r != rr) {
                          logger.debug(_.join(&#x27; &#x27;, &#x27;Redirect current domain&#x27;, r, &#x27;to the main domain&#x27;, rr));
                          res.redirect(301, _.join(&#x27;&#x27;, rr, req.path));
                        } else {
                            // redirect is already done so process normal process
                            next();
                        }
                      });
                    }
                  }
                }                
              }
            }
          } 
        }        
      }
    }    
  }

  /**
   * Processing favicon
   */
  if (!(_.isUndefined(constants.ICONS_DIRECTORY))) {
    if (_.isString(constants.ICONS_DIRECTORY)) {
      
      var fav = _.join(&#x27;/&#x27;, constants.ICONS_DIRECTORY, &#x27;favicon.ico&#x27;);
      if (fs.existsSync(fav)) {
        logger.debug(_.join(&#x27; &#x27;, &#x27;Adding favicon : &#x27;, fav)); 
        app.use(favicon(fav,  { maxAge : 2592000000 } ));
      } else {
        logger.warning(_.join(&#x27; &#x27;, &quot;Favicon doesn&#x27;t exist. Checking path [&quot;, fav, &#x27;] failed&#x27;));
      }
    }
  }
  
  /**
   * Setting up the static public directory
   */
  logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up static directory to [&#x27;, constants.PUBLIC_DIRECTORY, &#x27;]&#x27;));
  app.use(express.static(constants.PUBLIC_DIRECTORY));

  /**
   * Setting up model conf
   */
  logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up views directory to [&#x27;, constants.VIEWS_DIRECTORY, &#x27;]&#x27;)); 
  app.set(&#x27;views&#x27;, constants.VIEWS_DIRECTORY);
  
  /**
   * Setting up view engine
   */
   if (!(_.isUndefined(eConfig))) {
     if (!(_.isUndefined(eConfig.viewEngine)) &amp;&amp; _.isString(eConfig.viewEngine)) {
       logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up view engine to [&#x27;, eConfig.viewEngine, &#x27;]&#x27;));
       app.set(&#x27;view engine&#x27;, eConfig.viewEngine);
     } else {
       logger.warning(&#x27;View engine config is missing. Setting up default view engine to jade&#x27;)
       app.set(&#x27;view engine&#x27;, &#x27;jade&#x27;);       
     }
   }
   logger.debug(&#x27;Enable JSONP for express&#x27;);
   app.enable(&#x27;jsonp callback&#x27;);

   /**
    * Setting up dependencies modules and routes
    */
    logger.debug(&#x27;Setting up Cookie Parser middleware for current express app&#x27;);
    app.use(cookieParser());    

    logger.debug(&#x27;Setting up json middleware support for current express app&#x27;);
    app.use(bodyParser.json({
      strict  : true,
      inflate : true,
      type    : &#x27;json&#x27;      
    }));    

    logger.debug(&#x27;Setting up urlencoded middleware support for current express app&#x27;);
    app.use(bodyParser.urlencoded({
      extended  : true,
      inflate   : true,
      type      : &#x27;urlencoded&#x27;      
    }));    

    logger.debug(&#x27;Setting up method-override middleware support for current express app&#x27;);
    app.use(methodOverride());

    if (!(_.isUndefined(eConfig))) {
      if (!(_.isUndefined(eConfig.session)) &amp;&amp; _.isObject(eConfig.session)) {
        var eSession = eConfig.session;
        
         var eSessionOptions = {};
         
         if (!(_.isUndefined(eSession.secret)) &amp;&amp; _.isString(eSession.secret)) {
           _.extend(eSessionOptions, { secret : eSession.secret });
         }

         if (!(_.isUndefined(eSession.name)) &amp;&amp; _.isString(eSession.name)) {
           _.extend(eSessionOptions, { name : eSession.name });
         }         

         if (!(_.isUndefined(eSession.secure)) &amp;&amp; _.isBoolean(eSession.secure)) {
           _.extend(eSessionOptions, { cookie : { secure : eSession.secure } });
         }         

         if (!(_.isUndefined(eSession.genuuid)) &amp;&amp; _.isBoolean(eSession.genuuid)) {
           if (eSession.genuuid) {
              var gen = function(req) {
                return uuid.v4();
              };
                           
               _.extend(eSessionOptions, { genid : gen });                                
           }
         }
         
         if (!(_.isUndefined(eSession.resave)) &amp;&amp; _.isBoolean(eSession.resave)) {
           _.extend(eSessionOptions, { resave : eSession.resave });
         }
         
         if (!(_.isUndefined(eSession.saveUninitialized)) &amp;&amp; _.isBoolean(eSession.saveUninitialized)) {
           _.extend(eSessionOptions, { saveUninitialized : eSession.saveUninitialized });
         }         
         
         if (!(_.isEmpty(eSessionOptions)) &amp;&amp; !(_.isUndefined(eSession.proxy)) &amp;&amp; _.isBoolean(eSession.proxy)) {
           if (eSession.proxy) {
             logger.debug(&#x27;Setting up proxy trust for session middleware to enable&#x27;);
             app.set(&#x27;trust proxy&#x27;, 1);
           }
           
           logger.debug(&#x27;Setting up expression session middleware support for current express app&#x27;);
           app.use(session(eSessionOptions));
         }
      }
    }

    /**
     * Setting up Social rules
     */
    logger.debug(&#x27;Setting up social rules =&gt; Facebook share for current express app&#x27;);     
    app.use(function(req, res, next) {

      // for facebook
      var userAgent = req.headers[&#x27;user-agent&#x27;];      

      // for seo
      var fragment  = req.query._escaped_fragment_;
      
      // Is Facebook ? 
      if (userAgent.indexOf(&#x27;facebookexternalhit&#x27;) &gt;= 0) {
        // get current host
        var host = utils.getCorrectHost(req);

        // generate facebook share
        social.generateFacebookShare(host, req.url, function(data) {
          if (!_.isEmpty(data)) {
            render.render(&#x27;social/facebook-share&#x27;, req, res, next, { sharetitle : data.title, facebook : data.facebook });
          } else {
            social.generateDefaultShare(host, req.url, function(data) { 
              if (!_.isEmpty(data)) {
                render.render(&#x27;social/facebook-share&#x27;, req, res, next, { sharetitle : data.title, facebook : data.facebook });
              } else {
                return next();
              }
            }, &#x27;facebook&#x27;);          
          }
        });        
      } else {
        // comment all for the moment only for facebook SEO snapshots for later
        return next();
      }
    });

    /**
     * Setting up SEO rules
     */
    logger.debug(&#x27;Setting up seo rules for html5 js app&#x27;);     
    app.use(prerender);

    /**
     * Setting up multipart for upload
     */
    logger.debug(&#x27;Setting up multipart support for current express app&#x27;);
    app.use(multipart());
    
    /**
     * Setting up flash middleware
     */
    logger.debug(&#x27;Setting up connect-flash middleware support for current express app&#x27;);
    app.use(flash());

    /**
     * Setting up dynamic helpders
     */
    logger.debug(_.join(&#x27; &#x27;, &#x27;Setting up dynamic helpers for express app with reference [&#x27;, app.get(&#x27;app_name&#x27;), &#x27;]&#x27;));
    app.use(helpers(app.get(&#x27;app_name&#x27;)));  

    /**
     * Setting up router
     */
    logger.debug(&#x27;Setting up Router for current express app&#x27;);    
    app.use(express.Router());
    
    logger.info(&#x27;Express is ready to use ....&#x27;)
};









































    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
