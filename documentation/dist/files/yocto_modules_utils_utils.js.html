<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>yocto_modules/utils/utils.js - yocto-core-stack</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-core-stack" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Gruntfile.html">Gruntfile</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/copy.html">copy</a></li>
                                <li><a href="../modules/Grunt file.html">Grunt file</a></li>
                                <li><a href="../modules/jshint.html">jshint</a></li>
                                <li><a href="../modules/ng.html">ng</a></li>
                                <li><a href="../modules/ngMessages.html">ngMessages</a></li>
                                <li><a href="../modules/ngMock.html">ngMock</a></li>
                                <li><a href="../modules/ngMockE2E.html">ngMockE2E</a></li>
                                <li><a href="../modules/uglify.html">uglify</a></li>
                                <li><a href="../modules/yuidoc.html">yuidoc</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: yocto_modules/utils/utils.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Dependencies
 * @see : http://underscorejs.org/
 * @see : https://github.com/epeli/underscore.string
 * @see : http://nodejs.org/api/fs.html
 * @see : http://nodejs.org/api/path.html
 * @see :  http://nodejs.org/api/crypto.html
 * @see : http://aheckmann.github.io/gm/docs.html   
 * @author :  Mathieu ROBERT &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved
 */
 
var config        = require(&#x27;../../config/config&#x27;); 
var _             = require(&#x27;underscore&#x27;);
var _s            = require(&#x27;underscore.string&#x27;);
var path          = require(&#x27;path&#x27;);
var logger        = require(config.yoctoModules(&#x27;logger&#x27;));
var fs            = require(&#x27;fs&#x27;);
var crypto        = require(&#x27;crypto&#x27;);
var gm            = require(&#x27;gm&#x27;);

// mixin underscore js ans underscore.string js to use the same namespace
_.mixin(_s.exports());

/**
 * Main Object
 */
var utils = function() {};

/**
 * Force a require file to be reload from root path of the app
 * @param (String), path, the current path to use
 */
utils.prototype.forceRelodRequire = function(path) {
  delete(require.cache[path]);
  return require(_.join(&#x27;/&#x27;, &#x27;../..&#x27;, path, true));  
}

/**
 * Load a json file for db configuration 
 * @param (String), file, filename to use
 * @param (Boolean), filter, true if we need to use filter data, false otherwise
 * @return (Object), json reprensentation of file
 */
utils.prototype.loadDbJson = function(file, filter) {
  var json = {};
  
  try {
    file    = _.join(&#x27;&#x27;, file, &#x27;.json&#x27;);
    
    if (!_.isUndefined(filter) &amp;&amp; _.isString(filter)) {
      var p   = _.join(&#x27;/&#x27;, __dirname, &#x27;../../app/models/data&#x27;, filter, file);
    } else {
      var p   = _.join(&#x27;/&#x27;, __dirname, &#x27;../../app/models/data&#x27;, file);          
    }
    
    p       = path.normalize(p);
    json    = JSON.parse(fs.readFileSync(p, &#x27;utf-8&#x27;));
  } catch (e) {
      logger.error(_.join(&#x27; &#x27;, &#x27;Cannot load JSON for file :&#x27;, file, &#x27;Error is : &#x27;, e.message));
  }
  
  return json;  
}

/**
 * Load a json file for filter type 
 * @param (String), file, filename to use
 * @return (Object), json reprensentation of file
 */
utils.prototype.loadFilterDbJson = function(file) {
  return this.loadDbJson(file, &#x27;filter&#x27;);
}

/**
 * Load a json file for filter type 
 * @param (String), file, filename to use
 * @return (Object), json reprensentation of file
 */
utils.prototype.loadFormDbJson = function(file) {
  return this.loadDbJson(file, &#x27;form&#x27;);
}

/**
 * Utility function. remove no needed property on a current object
 * @param (Array), items list of items
 * @param (Array), item to exclude
 */
utils.prototype.omitItems = function(items, exclude) {
  return _.difference(items, exclude);
}

/**
 * Return true if has no difference between source and compare list
 * @param (Array|Object), source list of item
 * @param (Array|Object), compate list of item 
 * @return (Boolean), true is no difference, false otherwise
 */
utils.prototype.allItemIsInList = function(source, compare) {
  if (!_.isUndefined(source) &amp;&amp; !_.isUndefined(compare)) {
    if (!_.isArray(source) &amp;&amp; _.isObject(source)) {
      source = Object.keys(source);
    }

    if (!_.isArray(compare) &amp;&amp; _.isObject(compare)) {
      compare = Object.keys(compare);
    }

    if (_.isArray(source) &amp;&amp; _.isArray(compare)) {      
      return _.isEmpty(this.omitItems(source, compare));
    }    
  }
  
  return false;
}

/**
 * Get the default mail template to build the correct template
 * @param (String), type, template type to use to retrive the current file
 * @param (Object), params, data to map with the template
 * @param (Boolean), encode, if true encode html chars
 * @return (String), current data to send
 */
utils.prototype.getEmailFullMessage = function(file, params, encode) {
  var p     = _.join(&#x27;/&#x27;, __dirname, &#x27;../../app/models/data/mail&#x27;, file);
  
  try {
    p         = path.normalize(p);
    var data  = fs.readFileSync(p, &#x27;utf-8&#x27;);
    
    _.each(params, function(value, key) {
      var rules = _.join(&#x27;&#x27;, &#x27;#&#x27;, key);
      var reg   = new RegExp(rules, &#x27;g&#x27;);
      data      = data.replace(reg, value);
    });

    return (encode) ? _.escapeHTML(data) : data;             
  } catch(e) {
      logger.error(_.join(&#x27; &#x27;, &#x27;Cannot load mail template for type :&#x27;, file, &#x27;Error is : &#x27;, e.message));
  }
}

/**
 * Get the default mail config to process next step (building)
 * @param (String), type, template type to use to retrive the current file
 * @param (Object), params, data to map with the template
 * @return (Object), current config data
 */
utils.prototype.getEmailConfigByType = function(type, params) {
  var p     = _.join(&#x27;/&#x27;, __dirname, &#x27;../../app/models/data/mail/config.json&#x27;);
  var obj   = [];
  
  try {
    p         = path.normalize(p);
    var data  = JSON.parse(fs.readFileSync(p, &#x27;utf-8&#x27;));

    if (_.has(data, &#x27;rules&#x27;)) {
      var rules = data.rules;
      
      _.every(rules, function(rule) {
        if (_.has(rule, &#x27;type&#x27;) &amp;&amp; _.has(rule, &#x27;title&#x27;) &amp;&amp; _.has(rule, &#x27;template&#x27;)) {
          if (!_.isEmpty(rule.type) &amp;&amp; rule.type == type) {
            obj.push(rule);
            return false
          }
        }
        
        return true;
      });
    }
    
    return obj;    
  } catch(e) {
    logger.error(_.join(&#x27; &#x27;, &#x27;Cannot load mail config for type :&#x27;, type, &#x27;Error is : &#x27;, e.message));
  }
}

/**
 * Build notify object to send to DAO model
 * @param (Object), factory to use
 * @param (String), type to use
 * @param (String), subject to replace on original subject
 * @param (Object), params to assign on template
 * @return (Object), data to insert
 */
utils.prototype.buildNotify = function(factory, ctype, csubject, params) {
  // process contact on notify queue here
  // check is params is valid
  var notify    = factory.getLogs(&#x27;notify_queue&#x27;);
  var subject   = &#x27;&#x27;;
  var template  = &#x27;&#x27;;    
  var obj       = {};
  
  var config  = this.getEmailConfigByType(ctype, params, false);
  // check required
  if (!_.isUndefined(factory) &amp;&amp; !_.isUndefined(ctype) &amp;&amp; !_.isUndefined(csubject) &amp;&amp; !_.isUndefined(params)) {
    if (!_.isEmpty(ctype)) {
      _.every(config, function(item) { 
        if (_.has(item, &#x27;type&#x27;) &amp;&amp; _.has(item, &#x27;title&#x27;) &amp;&amp; _.has(item, &#x27;template&#x27;)) {
          if (item.type.toLowerCase() == ctype.toLowerCase()) {
            subject   = item.title;
            template  = item.template;
            
            // replace string
            if (_.isString(csubject)) {              
              subject = subject.replace(&#x27;#subject&#x27;, csubject);
            }
            
            // replace multiple item
            if (_.isArray(csubject) || _.isObject(csubject)) {
              _.each(csubject, function(item, key) {
                subject = subject.replace(_.join(&#x27;#&#x27;, &#x27;&#x27;, key), item);
              });
            }
                          
            return false;
          }
        }
        return true;
      });
    }        
  }
  
  // check subject
  if (!_.isEmpty(subject) &amp;&amp; !_.isEmpty(template)) {
    var message = this.getEmailFullMessage(template, params, false);
                
    // not empty so run save notify
    if (!_.isEmpty(message)) {
      obj = { 
        subject       : subject,
        mail_to       : params.email,
        full_message  : message,
        type          : ctype
      };

      if (_.has(params, &#x27;reference&#x27;)) {
        _.extend(obj, { ad_reference :  params.reference });
      }

      if (_.has(params, &#x27;ad_link&#x27;)) {
        _.extend(obj, { ad_link :  params.ad_link });
      }
    } else {
      logger.error(&#x27;Cannot build object for notify saving. message is empty&#x27;);      
    }
  } else {
    logger.error(&#x27;Cannot build object for notify saving. subject or template file is missing&#x27;);
  }
  
  return obj;  
}



/**
 * Return a password from two rules
 * @param (Integer), n, password length
 * @param (String), a, chars to use 
 */
utils.prototype.randomizedPassword = function(n, a) {
  
  if (_.isUndefined(a) || _.isEmpty(a) || _.isNull(a)) {
    a = &#x27;qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM1234567890&amp;(!-_%&lt;&gt;&#x27;;
  }
  
  var index = (Math.random() * (a.length - 1)).toFixed(0);
  return n &gt; 0 ? a[index] + this.randomizedPassword(n - 1, a) : &#x27;&#x27;;
}

/**
 * Utility function to encrypt data
 * @param (String), key, key to use for encryption
 * @param (Mixed), data, data to encrypt
 * @return (String), crypted data
 */
utils.prototype.encrypt = function(key, data) {
  data = JSON.stringify(data);

  var cipher  = crypto.createCipher(&#x27;aes256&#x27;, key);
  var crypted = cipher.update(data, &#x27;utf-8&#x27;, &#x27;hex&#x27;);
  crypted     += cipher.final(&#x27;hex&#x27;);
  
  return crypted;
}

/**
 * Utility function to decrypt data
 * @param (String), key, key to use for encryption
 * @param (Mixed), data, data to encrypt
 * @return (String), decrypted data 
 */
utils.prototype.decrypt = function(key, data) {
  var decipher  = crypto.createDecipher(&#x27;aes256&#x27;, key);
  var decrypted = decipher.update(data, &#x27;hex&#x27;, &#x27;utf-8&#x27;);
  decrypted     += decipher.final(&#x27;utf-8&#x27;);

  return JSON.parse(decrypted);
}

/**
 * Utility function to build date list for search view
 * @param (Integer), min, start value
 * @param (Integer), max, end value
 * @param (String), prefixMin, prefix to use on min value
 * @param (String), prefixMax, prefix to use on max value
 * @param (Boolean), reverse, true if we need to reverse array
 * @return (Array), list of date
 */
utils.prototype.generateSearchDateList = function(min, max, prefixMin, prefixMax, reverse) {
  var list  = [];
  var date  = new Date();

  // init with default value to prevent infinite loop   
  max       = max || date.getFullYear();
  min       = min || 0;

  // process number
  for(var i = min; i &lt;= max; i++) {
    list.push(i.toString());
  }

  // check is prefix is needed on list  
  if (!_.isNull(prefixMin) &amp;&amp; !_.isEmpty(prefixMin)) {
    list[0] = _.join(&#x27; &#x27;, prefixMin, list[0]);
  } 
  
  // check is prefix is needed on list
  if (!_.isNull(prefixMax) &amp;&amp; !_.isEmpty(prefixMax)) {
    list[list.length - 1] = _.join(&#x27; &#x27;, prefixMax, list[list.length - 1]);
  } 

  // reverse if needed
  if (!_.isNull(reverse) &amp;&amp; reverse) {
    list = list.reverse();
  }
  
  return list;
}

/**
 * Return the correct host from a request header.
 * Implement x-forwarded data
 * @param (Object), HTTP request object 
 */
utils.prototype.getCorrectHost = function(request) {
  if (!_.isUndefined(request)) {
    return _.join(&#x27;://&#x27;, request.protocol, request.get(&#x27;x-forwarded-host&#x27;) || request.get(&#x27;x-forwarded-server&#x27;) || request.get(&#x27;host&#x27;) || &#x27;localhost&#x27;); 
  }
  
  return null;
}

/**
 * Check if is an allowed image type format
 * @param (String), type to check
 * @return (Boolean), true if is correct false otherwise
 */
utils.prototype.isValidImageFormat = function(type) {
  type = _.join(&#x27;|&#x27;, &#x27;&#x27;, type.toLowerCase(), &#x27;&#x27;);
  return &#x27;|jpg|png|jpeg|gif|&#x27;.indexOf(type) !== -1;
}

/**
 * Process image and fit it from rules
 * @param (String), path, current path to use
 * @param (Integer), maxWidth, current maxWidth to use
 * @param (Integer), maxHeight, current maxHeight to use
 * @param (Integer), quality, current quality to use     
 */
utils.prototype.fitUploadedFile = function(path, maxWidth, maxHeight, quality) {
  // assign path
  var currentFile = path;

  // prevent null value and set up default value
  maxWidth    = maxWidth  || 670;
  maxHeight   = maxHeight || 470;
  quality     = quality   || 60;

  var $this = this;
  // get format 
  gm(path).format(function(err, value) {
    if (!err &amp;&amp; !_.isUndefined(value)) {

      // check if is valid type before
      if ($this.isValidImageFormat(value)) {  
        // process
        gm(currentFile).size(function(err, size) {
          if (!err) {
            if (size.width &gt; maxWidth || size.height &gt; maxHeight) {
              gm(currentFile)
              .geometry(maxWidth, maxHeight, &#x27;&gt;&#x27;)
              .quality(quality)
              .write(path, function (err) {
                if (!err) {
                  logger.debug(_.join(&#x27; &#x27;, &#x27;Fit image is success for path :&#x27;, path));
                } else {
                  logger.debug(_.join(&#x27; &#x27;, &#x27;Fit image is failed for path :&#x27;, path, &#x27;error is :&#x27;, err));
                }
              });
            } else {
              logger.debug(_.join(&#x27; &#x27;, &#x27;Fit image is not necessary for path :&#x27;, path));
            }
          }
        });
      } else {
        logger.error(_.join(&#x27; &#x27;, &#x27;Invalid format for fit image on path :&#x27;, path));            
      }
    } else {
      logger.error(_.join(&#x27; &#x27;, &#x27;Retrieve format on current image failed for path :&#x27;, path, &#x27;error is :&#x27;, err));
    }
  });
}

/**
 * Expose Utils
 */
module.exports  = new utils();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
