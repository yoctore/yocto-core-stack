<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>yocto_modules/dbfactory/dbfactory.js - yocto-core-stack</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-core-stack" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Gruntfile.html">Gruntfile</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/copy.html">copy</a></li>
                                <li><a href="../modules/Grunt file.html">Grunt file</a></li>
                                <li><a href="../modules/jshint.html">jshint</a></li>
                                <li><a href="../modules/ng.html">ng</a></li>
                                <li><a href="../modules/ngMessages.html">ngMessages</a></li>
                                <li><a href="../modules/ngMock.html">ngMock</a></li>
                                <li><a href="../modules/ngMockE2E.html">ngMockE2E</a></li>
                                <li><a href="../modules/uglify.html">uglify</a></li>
                                <li><a href="../modules/yuidoc.html">yuidoc</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: yocto_modules/dbfactory/dbfactory.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Dependencies
 * @see : http://underscorejs.org/
 * @see : http://epeli.github.io/underscore.string/
 * @author :  Mathieu ROBERT &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved 
 */

var config  = require(&#x27;../../config/config&#x27;);
var _       = require(&#x27;underscore&#x27;);
var _s      = require(&#x27;underscore.string&#x27;);
var logger  = require(config.yoctoModules(&#x27;logger&#x27;));
var utils   = require(config.yoctoModules(&#x27;utils&#x27;));

// mixin underscore and underscore.string to use the same scope
_.mixin(_s.exports());

/**
 * Default Db factory class
 */
var DbFactory = function() {};

/**
 * Default factory database object
 */
DbFactory.prototype.database        = {};
DbFactory.prototype.databaseLength  = 0;
DbFactory.prototype.currentModel;

/**
 * Default DbFactory type constants
 */
DbFactory.prototype.TYPE_AD                 = &#x27;ad&#x27;;
DbFactory.prototype.TYPE_CONSTANTS          = &#x27;constants&#x27;;
DbFactory.prototype.ERROR_TYPE              = &#x27;error&#x27;;
DbFactory.prototype.SUCCESS_TYPE            = &#x27;success&#x27;;
DbFactory.prototype.ASSOCIATE_METHOD        = &#x27;associate&#x27;;
DbFactory.prototype.INITIALIZE_METHOD       = &#x27;initialize&#x27;;
DbFactory.prototype.MAP_DATA_METHOD         = &#x27;mapping&#x27;;

/**
 * Default use Db function. Save Db Object into the current object
 */
DbFactory.prototype.useDb = function(database) {
  this.databaseLength = Object.keys(database).length;
  this.database       = database;
  
  logger.debug(&#x27;Factory : all is ready&#x27;);
  logger.debug(_.join(&#x27; &#x27;, &#x27;Factory : contains [&#x27;, this.databaseLength, &#x27;]&#x27;, &#x27;items.&#x27;));
  logger.debug(_.join(&#x27; &#x27;, &#x27;Factory : items keys are [&#x27;, Object.keys(this.database), &#x27;]&#x27;));
}

/**
 * Get How nb item factory use
 * @return (Integer), database item nb item
 */
DbFactory.prototype.getNbDbItem = function() {
  return this.databaseLength;
}

/**
 * Get default Models from rules
 * @param (String), cType, default model type to use
 * @param (String), type, needed type to use
 * @return (Sequelize Object), default table object
 */
DbFactory.prototype.getModels = function(cType, type) {
  var result    = {};
  var dbPrefix  = &#x27;ad_&#x27;; 
  var $this     = this;  
  var cName     = type.toLowerCase();
  
  if (cType == this.TYPE_AD) {
    cName = _.join(&#x27;&#x27;, dbPrefix, type.toLowerCase()).toLowerCase();    
  }
  
  if (!(_.isUndefined(this.database)) &amp;&amp; !(_.isNull(this.database))) {
    Object.keys(this.database).forEach(function(name) {
        if (cType == this.TYPE_AD) {
          if (_(name).startsWith(dbPrefix)) {
            if (name.toLowerCase() == cName) {
              $this.currentModel = cName;
              result = $this.database[cName];
            }
          }          
        } else {
          if (name.toLowerCase() == cName) {
            $this.currentModel = cName;
            result = $this.database[cName];
          }          
        }
    });  
  }
  
  return result;
}

/**
 * Get Ad Models from rules (Cf. BDD Schema)
 * @param (String), type, needed type to use
 * @return (Sequelize Object), default table object
 */
DbFactory.prototype.getAd = function(type) {
  var cDb = this.getModels(this.TYPE_AD, type);
  
  if (_.isEmpty(cDb)) {
    throw new Error(_.join(&#x27; &#x27;, &#x27;Cannot get correct ad from type :&#x27;, type));
  }
  
  return cDb;
}

/**
 * Get Logs from rules (Cf. BDD Schema)
 * @param (String), type, needed type to use
 * @return (Sequelize Object), default table object
 */
DbFactory.prototype.getLogs = function(type) {
  return this.getConstants(type);
}

/**
 * Get Constants from rules (Cf. BDD Schema)
 * @param (String), type, needed type to use
 * @return (Sequelize Object), default table object
 */
DbFactory.prototype.getConstants = function(type) {
  var cConstants = this.getModels(this.TYPE_CONSTANTS, type);
  
  if (_.isEmpty(cConstants)) {
    throw new Error(_.join(&#x27; &#x27;, &#x27;Cannot get correct constant from type :&#x27;, type));
  }  
  
  return cConstants;
}

/**
 * Get a status type from rules
 * @param (Boolean), true for success type of false for error type
 * @return (String), needed type
 */
DbFactory.prototype.getStatusType = function(success) {
  return (success ? this.SUCCESS_TYPE : this.ERROR_TYPE);
}

/**
 * Get default extra params for db
 * @return (Object), extra params
 */
DbFactory.prototype.getDefaultExtra = function() {
  return { status : this.ERROR_TYPE, msg : &#x27;&#x27;, data : {} };
} 

/**
 * Build default extra params from two object
 * @param (Object), extra, default params
 * @param (Object), newExtra, default extra params
 * @return (Object) return object processed
 */
DbFactory.prototype.buildExtra = function(extra, newExtra) {
  
  var newExtra = _.extend(extra, newExtra)
  
  if ((_.has(newExtra, &#x27;status&#x27;) &amp;&amp; _.has(newExtra, &#x27;msg&#x27;))) {
    if (newExtra.status == this.ERROR_TYPE) {
      logger.error(newExtra.msg);
    }
  }
  
  return newExtra;
}

/**
 * Default function to process requirement for database
 * @param (Function), callback to use
 * @param (String), rules to select the correct method
 */
DbFactory.prototype.processRequirements = function(callback, crules) {
  var $this = this;

  if ((!_.isNull(crules)) &amp;&amp; (!_.isEmpty(crules)) &amp;&amp; (crules == this.ASSOCIATE_METHOD || crules == this.INITIALIZE_METHOD || crules == this.MAP_DATA_METHOD)) {
    if (!(_.isUndefined(this.database)) &amp;&amp; !(_.isNull(this.database))) {
    
      logger.info(_.join(&#x27; &#x27;, &#x27;Database :&#x27;, crules, &#x27;Object ... [STARTED]&#x27;));
      
      _.every(this.database, function(model, key) {
  
        if ((!_.isUndefined(model) &amp;&amp; _.has(model, &#x27;options&#x27;))) {
          if (_.has(model.options, &#x27;classMethods&#x27;)) {
            var rules       = new Array();          
            
            if (crules == $this.ASSOCIATE_METHOD) {
              var associate   = _.has(model.options.classMethods, $this.ASSOCIATE_METHOD);
          
              
              var assObj = {
                cname     : $this.ASSOCIATE_METHOD,
                cdb       : $this.database,
                ckey      : key,
                cfunc     : (associate ? model.options.classMethods[$this.ASSOCIATE_METHOD] : null),
                ccallback : callback,
                cstatus   : {
                  type : $this.ASSOCIATE_METHOD,
                  name : key
                }              
              };
              
              rules.push(assObj);              
            }

            if (crules == $this.INITIALIZE_METHOD) {
              var initialize  = _.has(model.options.classMethods, $this.INITIALIZE_METHOD);
              
              var initObj = {
                cname     : $this.INITIALIZE_METHOD,
                cdb       : $this.database,
                ckey      : key,
                cfunc     : (initialize ? model.options.classMethods[$this.INITIALIZE_METHOD] : null),
                ccallback : callback,
                cstatus   : {
                  type : $this.INITIALIZE_METHOD,
                  name : key
                }              
              };
              
              rules.push(initObj);
            }
            
            if (crules == $this.MAP_DATA_METHOD) {
              var map  = _.has(model.options.classMethods, $this.MAP_DATA_METHOD);
              
              var mapObj = {
                cname     : $this.MAP_DATA_METHOD,
                cdb       : $this.database,
                ckey      : key,
                cfunc     : (map ? model.options.classMethods.mapping : null),
                ccallback : callback,
                cstatus   : {
                  type : $this.MAP_DATA_METHOD,
                  name : key
                }              
              };
              
              rules.push(mapObj);              
            }      

            _.every(rules, function(item) {
              if (!_.isNull(item.cfunc)) {
                $this.processSubRequirement(item.cname, item.cdb, item.cfunc, item.ckey, item.ccallback, item.cstatus);              
              } else {
                logger.debug(_.join(&#x27; &#x27;, &#x27;Model =&gt; [&#x27;, item.ckey, &#x27;]&#x27;, &quot;doesn&#x27;t contains&quot;, item.cname, &quot;method. Updating status ...&quot;));
                callback(item.cstatus);
              }
              return true;
            });
  
            return true;
          }
        }  
      });
    }     
  }
}

/**
 * Default method to process sub requirement of required database init
 * @param (String), method name
 * @param (Object), database object name
 * @param (Function), function to call
 * @param (String), model name
 * @param (Function), callback to use
 * @param (Object), Status object to use for app update
 */
DbFactory.prototype.processSubRequirement = function(methodName, db, method, key, callback, status) {
  logger.debug(_.join(&#x27; &#x27;, &#x27;Model =&gt; [&#x27;, key, &#x27;]&#x27;, &#x27;contains&#x27;, methodName , &#x27;method. Processing ...&#x27;));    
  
  if (methodName == this.ASSOCIATE_METHOD || methodName == this.MAP_DATA_METHOD) {
    method(db, callback, status);    
  }
  if (methodName == this.INITIALIZE_METHOD) {
    method(callback, status);    
  }
}

/**
 * Get Enum list of database model
 * @param (String), rules to use
 * @return (Array), results
 */
DbFactory.prototype.getEnumListFromRules = function(rules) {
  var $this  = this; 
  var crules = new Array();
  var result = new Array();
  
  if (_.isArray(rules)) {
    crules = rules;
  }
  if (_.isString(rules)) {
    crules.push(rules);
  }
  
  if (!(_.isUndefined(this.database)) &amp;&amp; !(_.isNull(this.database)) &amp;&amp; !_.isEmpty(crules)) {
    _.each(crules, function(rule) {
      Object.keys($this.database).forEach(function(name) {        
        if (name.toLowerCase() == rule.toLowerCase()) {
          var obj = $this.database[name];
          
          if ((!_.isUndefined(obj)) &amp;&amp; _.has(obj, &#x27;options&#x27;)) {
            if (_.has(obj.options, &#x27;classMethods&#x27;)) {
              if (_.has(obj.options.classMethods, &#x27;getEnumValues&#x27;)) {
                result = obj.options.classMethods.getEnumValues($this, name.toLowerCase());
              }
            }
          }
        }
      });
    });
  }
  
  return result;
}

/**
 * Get List of filter from specific rules
 * @param (Mixed), for enum rules
 * @param (String), default filter rules to load
 * @return (Object), filters
 */
DbFactory.prototype.getFilterFromRules = function(aRules, fRules) {
  var filters = utils.loadFilterDbJson(fRules);
  var enums   = this.getEnumListFromRules(aRules);
  var $this   = this;
  
  if (_.has(filters, &#x27;filter&#x27;)) {
    var datas = filters.filter;   
    var flist = utils.loadFilterDbJson(&#x27;list&#x27;);
    
    if (!_.isEmpty(flist) &amp;&amp; _.has(flist, &#x27;list&#x27;)) {
      flist = flist.list;
      
      for (var i = 0; i &lt; datas.length; i++) {
        _.every(flist, function(list) {
          
          if (_.has(list, &#x27;reference&#x27;) &amp;&amp; !_.isNull(list.reference) &amp;&amp; _.has(list, &#x27;values&#x27;) &amp;&amp; !_.isNull(list.values) &amp;&amp; _.isArray(list.values)) {
            if (list.reference == datas[i].values) {
              
              // generate Date
              if (_.has(list, &#x27;dynamic_date&#x27;) &amp;&amp; _.has(list, &#x27;min&#x27;) &amp;&amp; _.has(list, &#x27;max&#x27;) &amp;&amp; _.has(list, &#x27;prefix_min&#x27;) &amp;&amp; _.has(list, &#x27;prefix_max&#x27;) &amp;&amp; _.has(list, &#x27;reverse&#x27;)) {
                datas[i].values = utils.generateSearchDateList(list.min, list.max, list.prefix_min, list.prefix_max, list.reverse);
              } else {
                datas[i].values = list.values;
              }            
            }
          }
          
          return true;
        });
        
        if (_.has(datas[i], &#x27;internal&#x27;)) {
          _.every(enums, function(aenum) {
            if (datas[i].internal == aenum.key) {
              var assign = aenum.values;

              if (_.has(datas[i], &#x27;exclude&#x27;)) {
                if (_.isArray(datas[i].exclude)) {
                  datas[i].exclude = _.map(datas[i].exclude, function(s) {
                    return s.toLowerCase();
                  });
                                    
                  if (_.has(aenum, &#x27;values&#x27;)) {
                    assign = _.difference(aenum.values, datas[i].exclude);
                  }
                }
              }
              datas[i].values = assign;
              delete datas[i].interval;
            }
            
            return true;
          });
        }
      }             
    }
    
    filters.filter = datas;     
  }
  
  return filters;
}

/**
 * Get list of item for a part of form from specific rules
 * @param (Mixed), for enum rules
 * @param (String), default filter rules to load
 * @return (Object), filters
 */
DbFactory.prototype.getFormFromRules = function(aRules, fRules) { 
  
  var filters = utils.loadFormDbJson(fRules);
  var enums   = this.getEnumListFromRules(aRules);  
  var datas   = new Array();

  if (_.has(filters, &#x27;items&#x27;) &amp;&amp; _.isArray(filters.items)) {
    _.each(filters.items, function(item) {
        datas.push(item);
        
        for (var i = 0; i &lt; datas.length; i++) {
          if (_.has(datas[i], &#x27;internal&#x27;)) {
            _.every(enums, function(aenum) {
                                          
              if (datas[i].internal == aenum.key) {
                var exclude = false;
                // Exclude item form form rules
                if (_.has(datas[i], &#x27;exclude&#x27;)) {
                  if (_.isArray(datas[i].exclude)) {
                    datas[i].exclude = _.map(datas[i].exclude, function(s) {
                      return s.toLowerCase();
                    });
                                      
                    if (_.has(aenum, &#x27;values&#x27;)) {
                      datas[i].values = _.difference(aenum.values, datas[i].exclude);
                      exclude = true;
                    }
                  }
                }

                // re assign values
                if (_.has(datas[i], &#x27;values&#x27;)) {
                  delete datas[i].internal;         
                  datas[i].values = (!exclude ? aenum.values : datas[i].values);

                  return false;  
                }
              }
              return true;
            });
          }
                              
          if (_.has(datas[i], &#x27;custom&#x27;)) {
            if (datas[i].custom == &#x27;date&#x27;) {
              if (_.has(datas[i], &#x27;max&#x27;)) {
                var d = new Date();
                datas[i].max = d.getFullYear();
              }
            }
            
            if (datas[i].custom == &#x27;job-category&#x27;) {
              var flist = utils.loadFilterDbJson(&#x27;list&#x27;);
               
              if (!_.isEmpty(flist) &amp;&amp; _.has(flist, &#x27;list&#x27;)) {
                flist = flist.list;
                
                _.every(flist, function(list) {
                 
                  if (_.has(list, &#x27;reference&#x27;) &amp;&amp; !_.isNull(list.reference) &amp;&amp; _.has(list, &#x27;values&#x27;) &amp;&amp; !_.isNull(list.values) &amp;&amp; _.isArray(list.values) &amp;&amp; !_.isEmpty(list.values)) {
                    if (list.reference == datas[i].custom) {
                      datas[i].values = list.values;
                      return false;    
                    } 
                  }
                                  
                  return true; 
                }); 
              }
            }                        
          }
        }
    });
  }
  
  return datas;
}
/**
 * Get Default filter object to send
 * @param (String), the default label to use
 * @param (String), the default type to use
 * @param (String), the default name to use
 * @param (Array), the default values to use
 * @param (String), the default placeholder to use
 * @param (String), the default sql type  to use
 * @param (String), the default sql conditions to use 
 * @return (Object), the default filter object
 */
DbFactory.prototype.getDefaultFilterObject = function(label, type, name, values, placeholder, sqlType, sqlCondition) {
  var obj   = {};
  
  if (!_.isUndefined(type) &amp;&amp; !_.isUndefined(name) &amp;&amp; !_.isUndefined(values) &amp;&amp; !_.isUndefined(placeholder) &amp;&amp; !_.isUndefined(sqlType) &amp;&amp; !_.isUndefined(sqlCondition)) {
    if (!_.isNull(type) &amp;&amp; !_.isNull(name) &amp;&amp; !_.isNull(values) &amp;&amp; !_.isNull(placeholder) &amp;&amp; !_.isNull(sqlType) &amp;&amp; !_.isNull(sqlCondition)) {
      if (_.isString(type) &amp;&amp; _.isString(name) &amp;&amp; _.isArray(values) &amp;&amp; _.isString(placeholder) &amp;&amp; _.isString(sqlType) &amp;&amp; _.isString(sqlCondition)) {
        if (!_.isEmpty(type) &amp;&amp; !_.isEmpty(name) &amp;&amp; !_.isEmpty(placeholder) &amp;&amp; !_.isEmpty(sqlType) &amp;&amp; !_.isEmpty(sqlCondition)) {      
          
          obj = {
            label       : label, 
            type        : type, 
            name        : name, 
            values      : values,
            placeholder : placeholder, 
            sql : {
              type  : sqlType,
              rules : sqlCondition        
            }
          }
        }
      }
    }
  }
    
  return _.extend({}, obj);
}

/**
 * Default function to build a custom message for validate call on model
 * @param (Object), e, current error from validate call
 * @param (String), correct message to string format
 */
DbFactory.prototype.buildValidationErrors = function(e) {
  var err = new Array();
  
  if (!_.isUndefined(e)) {
    if (_.has(e, &#x27;errors&#x27;)) {
      if (_.isArray(e.errors)) {
        if (e.errors.length == 1) {
          var error = _.first(e.errors);

          if (_.has(error, &#x27;message&#x27;)) {
             err.push(error.message); 
          }
        } else {
          _.each(e.errors, function(error) {
            if (_.has(error, &#x27;message&#x27;)) {
              err.push(error.message);
            }
          });
        }
      }
    }
  }
  
  return _.toSentence(err, &#x27; | &#x27;, &#x27; | &#x27;);
}

/**
 * Build correct where list for search
 * @param (Object), filter object to process
 * @return (Array), array of item to process
 */
DbFactory.prototype.buildWhereForQuery = function(filters) {
  var wheres    = new Array();
  var andKeys   = null;
  var andValues = new Array();
  var orKeys    = null;
  var orValues  = new Array();
  var keys      = null;
  var values    = new Array();  

  /**
   * Default function to clean words (html entities, space)
   * @param (Array), list of item
   * @return (Array), item clean
   */ 
  function cleanWords(values) {
    return _.map(values, function(citem) {
      // cleaning words / strip tags for html
      // already process on view process here to prevent data injection

      // default process single item internal function
      function cprocess(value) {
        value = _.clean(value);
        value = _.trim(value);        
        value = _(value).stripTags();
        
        // convert item to number type
        var nvalue = _.toNumber(value);

        // if is a valid number process it to number for sequelize, otherwise keep it to current type                        
        if (_.isNumber(nvalue) &amp;&amp; !_.isNaN(nvalue)) {
          return nvalue;  
        } else {
          return value;
        }
      }
      
      // if array we need to loop 
      if (_.isArray(citem)) {
        _.each(citem, function(item, key) {
          item[key] = cprocess(item);
        })
      } else {
        citem = cprocess(citem);
      }

      // return
      return citem;
    });
  }

  /**
   * Clean Number format to correct format (10 000 &lt;=&gt; 10000, 3 Guests =&gt; 3, ect)
   * Remove all space and string on item. Check filtered list for more details
   * @param (Array), keys, lists of keys
   * @param (Array), values, lists of values
   * @return (Array), array of values processed
   */
  function cleanNumberRules(keys, values) {
    var itemToCleanForBdd = [&#x27;price&#x27;, &#x27;mileage&#x27;, &#x27;model_year&#x27;, &#x27;engine_size&#x27;, &#x27;nb_bedrooms&#x27;, &#x27;nb_guests&#x27;, &#x27;weekly_rent_price_min&#x27;, &#x27;weekly_rent_price_max&#x27;]; 
    
    // parse items
    for (var i = 0; i &lt; keys.length; i++) {
      var toProcess = keys[i];
      
      toProcess = toProcess.replace(/[\s&lt;=&gt;?]/g, &#x27;&#x27;);

      // check if item is contains on
      if (_.contains(itemToCleanForBdd, toProcess)) {
        if (!_.isUndefined(values[i]) &amp;&amp; !_.isNull(values[i]) &amp;&amp; _.isString(values[i])) {
          values[i] = values[i].replace(/[\s\D]/g, &#x27;&#x27;);
        }
      }
    }
    
    // return
    return values;      
  }

  // process and filter
  if (_.has(filters, &#x27;and&#x27;)) {
    if (_.has(filters.and, &#x27;keys&#x27;) &amp;&amp; _.has(filters.and, &#x27;values&#x27;)) {
      if (_.isArray(filters.and.keys) &amp;&amp; !_.isEmpty(filters.and.keys) &amp;&amp; _.isArray(filters.and.values) &amp;&amp; !_.isEmpty(filters.and.values)) {
        andKeys     =  _.toSentence(filters.and.keys, &#x27; AND &#x27;, &#x27; AND &#x27;);

        // clean item
        andValues   = cleanNumberRules(filters.and.keys, filters.and.values);        
        andValues   = cleanWords(andValues);

        // flatten item to transform array of array to an unique array @see underscore docs
        andValues   = _.flatten(andValues);
      }
    }
  }

  // process or filter
  if (_.has(filters, &#x27;or&#x27;)) {
    if (_.has(filters.or, &#x27;keys&#x27;) &amp;&amp; _.has(filters.or, &#x27;values&#x27;)) {
      if (_.isArray(filters.or.keys) &amp;&amp; !_.isEmpty(filters.or.keys) &amp;&amp; _.isArray(filters.or.values) &amp;&amp; !_.isEmpty(filters.or.values)) {
        orKeys    =  _.toSentence(filters.or.keys, &#x27; OR &#x27;, &#x27; OR &#x27;);
        orValues  = cleanWords(filters.or.values);
      }
    }
  }

  // Tricks for search filters
  // need to build query like ( ( block1 LIKE %value% AND block2 LIKE %value%) OR ( block1bis LIKE %value% AND block2bis LIKE %value%) )
  var kvalues = new Array();
  var fkeys   = null;

  if (_.has(filters, &#x27;keywords&#x27;)) {
    if (!_.isEmpty(filters.keywords)) {
      
      var kkwords = [];
      var kkeys   = [];
      
      var keywords = cleanWords([ filters.keywords ]);
      keywords = _.words(keywords);
      
      // build keywords rules with new search
      _.each(keywords, function(keyword) {
        // ignore little word ??? full search TEXT ??
        var pkword  = _.join(&#x27;&#x27;, &#x27;%&#x27;, keyword, &#x27;%&#x27;);
        var pattern = &#x27;(title_ad LIKE ? OR description LIKE ?)&#x27;;
        
        kvalues.push(pkword);
        kvalues.push(pkword);
        kkeys.push(pattern);
      });
      
      kkeys = _.toSentence(kkeys, &#x27; OR &#x27;, &#x27; OR &#x27;)
      fkeys = _.join(&#x27;&#x27;, &#x27;(&#x27;, kkeys, &#x27;)&#x27;);
    }    
  }
  
  // build correct where list
  if (!_.isNull(orKeys) &amp;&amp; !_.isNull(andKeys)) {
    keys = _.join(&#x27; &#x27;, orKeys, &#x27;AND&#x27;, andKeys);
    values.push(orValues);
    values.push(andValues);    
  } else {
    keys    = andKeys;
    values  = andValues;
  }

  // build keys 
  if (!_.isNull(keys) &amp;&amp; !_.isEmpty(keys) &amp;&amp; !_.isNull(fkeys) &amp;&amp; !_.isEmpty(fkeys)) {
    keys = _.join(&#x27; &#x27;, keys, &#x27;AND&#x27;, fkeys);
    values.push(kvalues);        
  }

  // process return
  if (!_.isNull(keys) &amp;&amp; !_.isNull(values)) {
    wheres.push(keys);
    wheres.push(values);
    wheres  = _.flatten(wheres);      
    return wheres;
  }

  return filters;
}

/**
 * Expose Db Factory
 */
module.exports = new DbFactory();         
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
