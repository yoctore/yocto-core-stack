/* yocto-core-stack - Core package for Yoctopus tools. - V3.0.0 */

"use strict";var logger=require("yocto-logger"),configure=require("./modules/configure"),core=require("./modules/core"),Q=require("q"),path=require("path"),fs=require("fs"),_=require("lodash");function CoreWrapper(){this.debug=!1,this.logger=logger,this.core={},this.modules=[],this.configPath="",this.env=process.env.NODE_ENV||"development"}CoreWrapper.prototype.init=function(){var e=Q.defer(),r=this;try{var o=path.normalize([process.cwd(),this.debug?"example/core.json":"core.json"].join("/"));o=JSON.parse(fs.readFileSync(o)),configure.init(o).then(function(o){if(r.configPath=o.config,_.has(o.env,r.env)){var t=o.env[r.env];logger.setLogLevel(t.logger.level),_.has(t.logger,"rotate")?logger.addDailyRotateTransport(t.logger.rotate.path,t.logger.rotate.name).then(function(){r.core=core(logger),e.resolve()},function(r){e.reject(r)}):e.resolve()}else e.reject("Environment vars is not defined cannot continue.")}).catch(function(r){var o=["Config file is invalid :",r].join(" ");e.reject(o)})}catch(r){var t=["Cannot init core :",r.message].join(" ");e.reject(t)}return e.promise},CoreWrapper.prototype.isReady=function(){return _.isString(this.configPath)&&!_.isEmpty(this.configPath)&&_.isArray(this.modules)&&!_.isEmpty(this.core)},CoreWrapper.prototype.start=function(){var e=Q.defer(),r=this;if(this.isReady())try{this.core.initialize(this.modules).then(function(){r.core.setConfigPath(r.configPath).then(function(){r.core.configure().then(function(){r.core.start().then(function(){e.resolve()}).catch(function(r){logger.error(["[ Core.stack.run ] - Cannot start app :",r].join(" ")),e.reject(r)})}).catch(function(r){logger.error(["[ Core.stack.run ] - Cannot configure core process :",r].join(" ")),e.reject(r)})}).catch(function(r){logger.error(["[ Core.stack.run ] - Cannot process config setting :",r].join(" ")),e.reject(r)})}).catch(function(r){logger.error(["[ Core.stack.run ] - Cannot process intialize :",r].join(" ")),e.reject(r)})}catch(r){logger.error(["[ Core.stack.run ] - An general error occured :",r.message].join(" ")),e.reject(r.message)}else e.reject("[ Core.stack.run ] - Cannot start app. Stack is not ready.");return e.promise},CoreWrapper.prototype.getConfig=function(){return this.core.config.config||{}},module.exports=new CoreWrapper;